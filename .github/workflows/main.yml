name: CI

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v1

    - name: Install apt dependencies
      run: |
        sudo apt install -y apt-utils clang curl git libblocksruntime-dev libxml2

    - uses: actions/setup-python@v1
      with:
        python-version: '3.6'
        architecture: 'x64'

    - name: Install pip dependencies
      run: |
        python --version
        pip install nbformat

    - name: Detect unstripped out notebook commits
      run: |
        echo "Trying to load all notebooks"
        tools/read-nbs
        echo "Check we are starting with clean git checkout"
        if [ -n "$(git status -uno -s)" ]; then echo "git status is not clean"; false; fi
        echo "Trying to strip out notebooks"
        tools/fastai-nbstripout -d dev_nb/*ipynb dev_nb/*/*ipynb dev_course/*/*ipynb
        echo "Check that strip out was unnecessary"
        git status -s # display the status to see which nbs need cleaning up
        if [ -n "$(git status -uno -s)" ]; then echo -e "!!! Detected unstripped out notebooks\n!!!Remember to run tools/run-after-git-clone"; false; fi

    - name: Diff nbs/module
      run: |
        echo "Diff nbs/module"
        pushd nbs
        if [ -n "$(python diff_nb_script.py)" ]; then echo -e "!!! Diff between nbs and scripts\n!!!Remember to run notebook2script.py or script2notebook.py"; false; fi

    - name: Install Swift Tensorflow
      run: |
        curl https://storage.googleapis.com/swift-tensorflow-artifacts/nightlies/latest/swift-tensorflow-DEVELOPMENT-ubuntu18.04.tar.gz > swift.tar.gz
        mkdir swift
        tar -C swift -xf swift.tar.gz


    - name: Build SwiftAI
      run: |
        export PATH=$(pwd)/swift/usr/bin:${PATH}
        swift build
        #swift test ## enable when tests are present
